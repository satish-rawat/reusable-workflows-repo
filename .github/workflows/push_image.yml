name: Reusable Push Image Workflow
on:
  workflow_call:
    inputs:
      image_name:
        required: true
        type: string
      dockerfile_path:
        required: false
        type: string
        default: Dockerfile
      image_tag:
        required: false
        type: string
        default: latest
      push_to:
        required: false
        type: string
        default: ecr
        description: "ecr or docker"
      ecr_registry:
        required: false
        type: string
      ecr_repository:
        required: false
        type: string
      aws_region:
        required: false
        type: string
        default: us-east-1
    secrets:
      AWS_ACCESS_KEY_ID:
        required: false
      AWS_SECRET_ACCESS_KEY:
        required: false
      DOCKER_USERNAME:
        required: false
      DOCKER_PASSWORD:
        required: false
    outputs:
      image_uri:
        description: "The pushed image URI"
        value: ${{ jobs.push.outputs.image_uri }}

jobs:
  build:
    uses: ./.github/workflows/build_image.yml
    with:
      image_name: ${{ inputs.image_name }}
      dockerfile_path: ${{ inputs.dockerfile_path }}
      image_tag: ${{ inputs.image_tag }}

  push:
    needs: build
    runs-on: ubuntu-latest
    outputs:
      image_uri: ${{ steps.set.outputs.image_uri }}
    steps:
      - name: Configure Image Variables
        id: set-vars
        run: |
          echo "IMAGE_NAME=${{ inputs.image_name }}" >> $GITHUB_ENV
          echo "IMAGE_TAG=${{ inputs.image_tag }}" >> $GITHUB_ENV

      - name: Push to Amazon ECR
        if: ${{ inputs.push_to == 'ecr' }}
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        run: |
          set -e
          aws configure set region "${{ inputs.aws_region }}"
          aws ecr get-login-password --region "${{ inputs.aws_region }}" | docker login --username AWS --password-stdin "${{ inputs.ecr_registry }}"
          docker tag "${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}" "${{ inputs.ecr_registry }}/${{ inputs.ecr_repository }}:${{ env.IMAGE_TAG }}"
          docker push "${{ inputs.ecr_registry }}/${{ inputs.ecr_repository }}:${{ env.IMAGE_TAG }}"
          echo "image_uri=${{ inputs.ecr_registry }}/${{ inputs.ecr_repository }}:${{ env.IMAGE_TAG }}" >> $GITHUB_OUTPUT

      - name: Push to Docker Hub
        if: ${{ inputs.push_to == 'docker' }}
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Tag & Push to Docker Hub
        if: ${{ inputs.push_to == 'docker' }}
        run: |
          docker tag "${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}" "${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}"
          docker push "${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}"
          echo "image_uri=${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}" >> $GITHUB_OUTPUT

      - name: Set fallback output (if none of the above matched)
        if: ${{ inputs.push_to != 'ecr' && inputs.push_to != 'docker' }}
        run: |
          echo "image_uri=${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}" >> $GITHUB_OUTPUT
